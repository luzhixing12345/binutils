<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/c.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/binutils.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">readelf</a><ul><li><a href="#h2-1">ELF 文件标准历史</a></li></ul><ul><li><a href="#h2-2">段表</a><ul><li><a href="#h3-3">段类型和标志位</a></li></ul><ul><li><a href="#h3-4">段的链接信息</a></li></ul></li></ul><ul><li><a href="#h2-5">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">readelf</h1><h2 id="h2-1">ELF 文件标准历史</h2><p>20世纪90年代, 一些厂商联合成立了一个委员会, 起草并发布了一个 ELF 文件格式标准供公开使用, 并希望所有人都可以遵循这项标准并从中获益. 1993 年委员会发布了 <a href="https://refspecs.linuxfoundation.org/elf/TIS1.1.pdf" target="_blank">ELF 文件标准</a>, 当时参与该委员会的有来自于编译器的厂商, 比如 Watcom(Watcom C/C++ 编译器) 和 Borland(Borland Turbo Pascal 编译器); 来自 CPU 的厂商比如 IBM 和 Intel; 来自操作系统的厂商比如IBM 和 Microsoft. 1995 年委员会发布了 <a href="https://refspecs.linuxfoundation.org/elf/elf.pdf" target="_blank">ELF1.2标准</a>, 自此委员会完成了自己的使命, 不久就解散了, 所以 ELF 文件格式标准的最新版本也是最后一个版本就是 1.2</p><blockquote><p><a href="https://refspecs.linuxfoundation.org" target="_blank">https://refspecs.linuxfoundation.org</a>/</p></blockquote><p>下面的内容会分析代码, 位于 examples/SimpleSection.c, 会随 make 一同编译, 最后得到 SimpleSection.o</p><pre class="language-c"><code><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType INT">int</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">printf</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator LPAREN">(</span><span class="Keyword QualifyType Token CONST">const</span><span class="Keyword QualifyType Token SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier CHAR">char</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Pointer Token Declarator POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator RPAREN">)</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token LF">
</span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="PrimaryExpression Constant Token NUMBER">84</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_uninit_var</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token LF">
</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType VOID">void</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">func1</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator LPAREN">(</span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Function BraceDepth-0 Token LCURLY_BRACE">{</span><span class="CompoundStatement Function Token LF">
</span><span class="CompoundStatement Function Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="String Token STRING">&quot;</span><span class="Format String Token STRING">%d</span><span class="Control String Token STRING">\n</span><span class="String Token STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="Identifier Token ID">i</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="CompoundStatement Function BraceDepth-0 Token RCURLY_BRACE">}</span><span class="CompoundStatement Function Token LF">
</span><span class="CompoundStatement Function Token LF">
</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType INT">int</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator LPAREN">(</span><span class="Keyword Token BaseType TypeSpecifier VOID">void</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Function BraceDepth-0 Token LCURLY_BRACE">{</span><span class="CompoundStatement Function Token LF">
</span><span class="CompoundStatement Function Token SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="PrimaryExpression Constant Token NUMBER">85</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var2</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="PrimaryExpression Constant Token NUMBER">1</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">func1</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">static_var</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">static_var2</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">a</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">b</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="CompoundStatement Function BraceDepth-0 Token RCURLY_BRACE">}</span></code></pre><h2 id="h2-2">段表</h2><p>ELF 文件的作用有两个,一是用于程序链接(为了生成程序);二是用于程序执行(为了运行程序). 从链接和运行的角度,可以将 ELF 文件的组成部分划分为 链接视图 和 运行试图 这两种格式, 如下所示.</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230819194148.png" alt="20230819194148"></p><p>其中右侧可执行程序中的 segment 实际上使用的方式是将多个 .o 中各个段合并到一起, 相同性质的段组合为一个大段, 如下所示</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230515145513.png" alt="20230515145513"></p><p>使用 <code>readelf -S</code> 可以得到所有的 14 个段的偏移量和大小</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Program Token ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-S</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.o</span><span class="Token LF">
</span><span class="Program Token ID">There</span><span class="Token SPACE"> </span><span class="Token ID">are</span><span class="Token SPACE"> </span><span class="Token NUMBER">14</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">starting</span><span class="Token SPACE"> </span><span class="Token ID">at</span><span class="Token SPACE"> </span><span class="Token ID">offset</span><span class="Token SPACE"> </span><span class="Token NUMBER">0x410</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Program Token ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">Headers:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Program Token ID">Nr</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Program Token ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE">                   </span><span class="Program Token ID">NULL</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000000</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.text</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000064</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Program Token ID">AX</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.rela.text</span><span class="Token SPACE">        </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000002</span><span class="Token ID">f0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000078</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Program Token ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">3</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.data</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">a4</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Program Token ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.bss</span><span class="Token SPACE">              </span><span class="Token ID">NOBITS</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ac</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000008</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Program Token ID">WA</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">4</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">5</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.rodata</span><span class="Token SPACE">           </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">ac</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Program Token ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">6</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.comment</span><span class="Token SPACE">          </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">b0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">000000000000002e</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000001</span><span class="Token SPACE">  </span><span class="Program Token ID">MS</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">7</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.note.GNU-stack</span><span class="Token SPACE">   </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000</span><span class="Token ID">de</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.note.gnu.pr</span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token ID">...</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">NOTE</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000e0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000020</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Program Token ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.eh_frame</span><span class="Token SPACE">         </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000100</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000058</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Program Token ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token NUMBER">10</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.rela.eh_frame</span><span class="Token SPACE">    </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000368</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000030</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Program Token ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">9</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token NUMBER">11</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000158</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000138</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">          </span><span class="Token NUMBER">12</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token NUMBER">12</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.strtab</span><span class="Token SPACE">           </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000290</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000060</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token NUMBER">13</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.shstrtab</span><span class="Token SPACE">         </span><span class="Token ID">STRTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000398</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000074</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Program Token ID">Key</span><span class="Token SPACE"> </span><span class="Token ID">to</span><span class="Token SPACE"> </span><span class="Token ID">Flags:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Function Token ID">W</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">write</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">A</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">alloc</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">X</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">execute</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">M</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">merge</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">S</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">strings</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">I</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">info</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Function Token ID">L</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">link</span><span class="Token SPACE"> </span><span class="Token ID">order</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">O</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">extra</span><span class="Token SPACE"> </span><span class="Token ID">OS</span><span class="Token SPACE"> </span><span class="Token ID">processing</span><span class="Token SPACE"> </span><span class="Token ID">required</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">G</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">group</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">T</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">TLS</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Function Token ID">C</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">compressed</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">x</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">unknown</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">o</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">OS</span><span class="Token SPACE"> </span><span class="Token ID">specific</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">E</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">exclude</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Function Token ID">D</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">mbind</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">l</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">large</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Function Token ID">p</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">processor</span><span class="Token SPACE"> </span><span class="Token ID">specific</span><span class="BraceDepth-0 Token RPAREN">)</span></code></pre><p>ELF 目标文件格式的最前部是 ELF 文件头(ELF HEADER), 它包含了描述整个文件的基本属性. 接着是 ELF 文件各个段, 其中 ELF 文件中与段有关的重要结构就是<i>*段表</i>*(Section Header Table), 该表描述了 ELF 包含的所有段的信息, 比如每个段的段名,段长度,文件中的偏移量,读写权限和段的其他属性</p><p>ELF 兼顾了32/64位机器, N=32,64, ElfN stands for Elf32 or Elf64, uintN_t stands for uint32_t or uint64_t</p><table><tr><th>typedef</th><th>type</th><th>32-bit size (bytes)</th><th>64-bit size (bytes)</th></tr><tr><td style="text-align:center">                ElfN_Addr</td><td style="text-align:center">                Unsigned program address, uintN_t</td><td style="text-align:center">                4</td><td style="text-align:center">                8</td></tr><tr><td style="text-align:center">                ElfN_Off</td><td style="text-align:center">                Unsigned file offset, uintN_t</td><td style="text-align:center">                4</td><td style="text-align:center">                8</td></tr><tr><td style="text-align:center">                ElfN_Section</td><td style="text-align:center">                Unsigned section index, uint16_t</td><td style="text-align:center">                2</td><td style="text-align:center">                2</td></tr><tr><td style="text-align:center">                ElfN_Versym</td><td style="text-align:center">                Unsigned version symbol information, uint16_t</td><td style="text-align:center">                2</td><td style="text-align:center">                2</td></tr><tr><td style="text-align:center">                Elf_Byte</td><td style="text-align:center">                unsigned char</td><td style="text-align:center">                1</td><td style="text-align:center">                1</td></tr><tr><td style="text-align:center">                ElfN_Half</td><td style="text-align:center">                uint16_t</td><td style="text-align:center">                2</td><td style="text-align:center">                2</td></tr><tr><td style="text-align:center">                ElfN_Sword</td><td style="text-align:center">                int32_t</td><td style="text-align:center">                4</td><td style="text-align:center">                4</td></tr><tr><td style="text-align:center">                ElfN_Word</td><td style="text-align:center">                uint32_t</td><td style="text-align:center">                4</td><td style="text-align:center">                4</td></tr><tr><td style="text-align:center">                ElfN_Sxword</td><td style="text-align:center">                int64_t</td><td style="text-align:center">                8</td><td style="text-align:center">                8</td></tr><tr><td style="text-align:center">                ElfN_Xword</td><td style="text-align:center">                uint64_t</td><td style="text-align:center">                8</td><td style="text-align:center">                8</td></tr></table><p>我们可以使用 <code>readelf</code> 来详细查看 ELF 文件, 先使用 -h 参数查看文件头</p><pre class="language-c"><code><span class="Keyword Token StorageType TYPEDEF">typedef</span><span class="Keyword Token StorageType SPACE"> </span><span class="Structure Token TypeSpecifier StructureType Keyword STRUCT">struct</span><span class="Structure Token TypeSpecifier StructureType Keyword SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="Keyword Token BaseType TypeSpecifier UNSIGNED">unsigned</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier CHAR">char</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_ident</span><span class="BraceDepth-1 Token DirectDeclaractorPostfix LSQUAR_PAREN">[</span><span class="PrimaryExpression Token TypeSpecifier Identifier MacroDefine ID">EI_NIDENT</span><span class="BraceDepth-1 Token DirectDeclaractorPostfix RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">// 一些信息</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_type</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">             </span><span class="Token StructDeclaration COMMENT">// 文件类型</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_machine</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">          </span><span class="Token StructDeclaration COMMENT">// CPU类型</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_version</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">          </span><span class="Token StructDeclaration COMMENT">// ELF版本号</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">ElfN_Addr</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">     </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_entry</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 入口地址</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">ElfN_Off</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_phoff</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 程序头入口</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">ElfN_Off</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_shoff</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 段表在文件中的偏移</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 标志位</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_ehsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">           </span><span class="Token StructDeclaration COMMENT">// ELF文件头大小</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_phentsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">        </span><span class="Token StructDeclaration COMMENT">// 程序头大小</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_phnum</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 程序头个数</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_shentsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">        </span><span class="Token StructDeclaration COMMENT">// 段表描述符大小, 等同于 sizeof(ElfN_Ehdr)</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_shnum</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">            </span><span class="Token StructDeclaration COMMENT">// 段表描述符数量</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint16_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">      </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">e_shstrndx</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">         </span><span class="Token StructDeclaration COMMENT">// 段表字符串表的在段表中的索引值</span><span class="Token StructDeclaration LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Structure Token SPACE"> </span><span class="Identifier DirectDeclaractor Token Typedefine ID">ElfN_Ehdr</span><span class="Declaration Token SEMI">;</span></code></pre><blockquote><p>其中e_entry入口地址指 ELF 程序的虚拟入口地址, 操作系统在加载完该程序后从这个而地址开始执行进程的指令, 可重定位文件一般没有入口地址</p></blockquote><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Program Token ID">readelf</span><span class="Token SPACE"> </span><span class="Token OPTION">-h</span><span class="Token SPACE"> </span><span class="Token PATH">examples/SimpleSection.o</span><span class="Token LF">
</span><span class="Program Token ID">ELF</span><span class="Token SPACE"> </span><span class="Token ID">Header:</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Magic:</span><span class="Token SPACE">   </span><span class="Token NUMBER">7</span><span class="Token ID">f</span><span class="Token SPACE"> </span><span class="Token NUMBER">45</span><span class="Token SPACE"> </span><span class="Token NUMBER">4</span><span class="Token ID">c</span><span class="Token SPACE"> </span><span class="Token NUMBER">46</span><span class="Token SPACE"> </span><span class="Token NUMBER">02</span><span class="Token SPACE"> </span><span class="Token NUMBER">01</span><span class="Token SPACE"> </span><span class="Token NUMBER">01</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE"> </span><span class="Token NUMBER">00</span><span class="Token SPACE">            </span><span class="Token COMMENT"># ELF魔数</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Class:</span><span class="Token SPACE">                             </span><span class="Token ID">ELF64</span><span class="Token SPACE">                            </span><span class="Token COMMENT"># 文件机器字节长度: 64位</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Data:</span><span class="Token SPACE">                              </span><span class="Token NUMBER">2</span><span class="Token APOSTROPHE">&#x27;</span><span class="Token ID">s</span><span class="Token SPACE"> </span><span class="Token ID">complement</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">little</span><span class="Token SPACE"> </span><span class="Token ID">endian</span><span class="Token SPACE">    </span><span class="Token COMMENT"># 数据存储方式: 补码小端</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Version:</span><span class="Token SPACE">                           </span><span class="Token NUMBER">1</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">current</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">                      </span><span class="Token COMMENT"># 版本</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token PATH">OS/ABI:</span><span class="Token SPACE">                            </span><span class="Token ID">UNIX</span><span class="Token SPACE"> </span><span class="Token MINUS">-</span><span class="Token SPACE"> </span><span class="Token ID">System</span><span class="Token SPACE"> </span><span class="Token ID">V</span><span class="Token SPACE">                  </span><span class="Token COMMENT"># 运行平台</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">ABI</span><span class="Token SPACE"> </span><span class="Token ID">Version:</span><span class="Token SPACE">                       </span><span class="Token NUMBER">0</span><span class="Token SPACE">                                </span><span class="Token COMMENT"># ABI版本</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Type:</span><span class="Token SPACE">                              </span><span class="Function Token ID">REL</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">Relocatable</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">           </span><span class="Token COMMENT"># ELF重定位类型</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Machine:</span><span class="Token SPACE">                           </span><span class="Token ID">Advanced</span><span class="Token SPACE"> </span><span class="Token ID">Micro</span><span class="Token SPACE"> </span><span class="Token ID">Devices</span><span class="Token SPACE"> </span><span class="Token ID">X86-64</span><span class="Token SPACE">    </span><span class="Token COMMENT"># 硬件平台</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Version:</span><span class="Token SPACE">                           </span><span class="Token NUMBER">0x1</span><span class="Token SPACE">                              </span><span class="Token COMMENT"># 硬件平台版本</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Entry</span><span class="Token SPACE"> </span><span class="Token ID">point</span><span class="Token SPACE"> </span><span class="Token ID">address:</span><span class="Token SPACE">               </span><span class="Token NUMBER">0x0</span><span class="Token SPACE">                              </span><span class="Token COMMENT"># 入口地址</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Start</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">          </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">bytes</span><span class="Token SPACE"> </span><span class="Token ID">into</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">              </span><span class="Token COMMENT"># 程序头入口</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Start</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">          </span><span class="Token NUMBER">1040</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">bytes</span><span class="Token SPACE"> </span><span class="Token ID">into</span><span class="Token SPACE"> </span><span class="Token ID">file</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">           </span><span class="Token COMMENT"># 段表的入口</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Flags:</span><span class="Token SPACE">                             </span><span class="Token NUMBER">0x0</span><span class="Token SPACE">                              </span><span class="Token COMMENT"># 标记位</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">this</span><span class="Token SPACE"> </span><span class="Token ID">header:</span><span class="Token SPACE">               </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">bytes</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">                       </span><span class="Token COMMENT"># ELF头部大小</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">           </span><span class="Token NUMBER">0</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">bytes</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">                        </span><span class="Token COMMENT"># 程序头长度</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Number</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">program</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">         </span><span class="Token NUMBER">0</span><span class="Token SPACE">                                </span><span class="Token COMMENT"># 程序头的数量</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Size</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">           </span><span class="Token NUMBER">64</span><span class="Token SPACE"> </span><span class="BraceDepth-0 Token LPAREN">(</span><span class="Token ID">bytes</span><span class="BraceDepth-0 Token RPAREN">)</span><span class="Token SPACE">                       </span><span class="Token COMMENT"># 段表每个条目的大小</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Number</span><span class="Token SPACE"> </span><span class="Token ID">of</span><span class="Token SPACE"> </span><span class="Token ID">section</span><span class="Token SPACE"> </span><span class="Token ID">headers:</span><span class="Token SPACE">         </span><span class="Token NUMBER">14</span><span class="Token SPACE">                               </span><span class="Token COMMENT"># 段表中的段数量</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">Section</span><span class="Token SPACE"> </span><span class="Token ID">header</span><span class="Token SPACE"> </span><span class="Token ID">string</span><span class="Token SPACE"> </span><span class="Token ID">table</span><span class="Token SPACE"> </span><span class="Token ID">index:</span><span class="Token SPACE"> </span><span class="Token NUMBER">13</span><span class="Token SPACE">                               </span><span class="Token COMMENT"># 字符串表的索引</span></code></pre><p>笔者将对应的含义标记在上面的输出结果的后面</p><blockquote><p>读者可以使用 <code>man elf</code> 来查看相关信息</p></blockquote><p>可以看到最前面的四个字节 <code>7f 45 4c 46</code> 是所有 ELF 文件都必须相同的标识码, 第一个字节对应 ASCII 的 DEL 控制符, 后面三个字节对应 ELF 三个字符的ASCII码, 这四个字节被称为 ELF 文件的<i>*魔数</i>*, 几乎所有可执行文件的开始的几个字节都是魔数</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506004437.png" alt="20230506004437"></p><p>比如 a.out 开始的为 0x01 0x07, PE/COFF 为 0x4d 0x5a(MZ). 魔数用来确定文件的类型, 操作系统在加载可执行文件的时候会确认魔数是否正确, 如果不正确会拒绝加载</p><blockquote><p>见 <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/binfmt_elf.c#n1368" target="_blank">fs/binfmt_elf.c:load_elf_library</a>, 在加载时判断了 if (memcmp(elf_ex.e_ident, ELFMAG, SELFMAG) != 0) goto out;</p></blockquote><p>有关文件类型和机器类型现如今已经有很多了, 笔者的实现并不全面, 有关机器类型还存在诸多扩展, 请参考 gnu binutils 源代码</p><pre class="language-c"><code><span class="Keyword Token BaseType TypeSpecifier CHAR">char</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Pointer Token Declarator POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">elf_type_name</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Keyword Token SelectionStatement SWITCH">switch</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">ehdr</span><span class="PostfixExpression Token UnaryExpression DOT">.</span><span class="Identifier Token ID">e_type</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">ET_NONE</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;NONE (None)&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">ET_REL</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;REL (Relocatable file)&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">ET_EXEC</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;EXEC (Executable file)&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">ET_DYN</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token LF">
</span><span class="LabeledStatement Token SPACE">        </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="LabeledStatement BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="FunctionCall Identifier Token PrimaryExpression ID">is_pie</span><span class="PostfixExpression BraceDepth-2 Token UnaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">file_data</span><span class="PostfixExpression BraceDepth-2 Token UnaryExpression RPAREN">)</span><span class="LabeledStatement BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="LabeledStatement Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">            </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;DYN (Position-Independent Executable file)&quot;</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">            </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;DYN (Shared object file)&quot;</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">ET_CORE</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;CORE (Core file)&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="JumpStatement Token COMMENT">// Processor Specific</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="JumpStatement Token COMMENT">// OS Specific</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token DEFAULT">default</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_type_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;unknown&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span></code></pre><pre class="language-c"><code><span class="Keyword Token BaseType TypeSpecifier CHAR">char</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Pointer Token Declarator POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">elf_machine_name</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Keyword Token SelectionStatement SWITCH">switch</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">ehdr</span><span class="PostfixExpression Token UnaryExpression DOT">.</span><span class="Identifier Token ID">e_machine</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Keyword LabeledStatement Token DEFAULT">default</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;An unknown machine&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_M32</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;AT&amp;T WE 32100&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_SPARC</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Sun Microsystems SPARC&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_386</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Intel 80386&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_68K</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Motorola 68000&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_88K</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Motorola 88000&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_860</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Intel 80860&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_MIPS</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;MIPS RS3000 (big-endian only)&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_PARISC</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;HP/PA&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_SPARC32PLUS</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;SPARC with enhanced instruction set&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_PPC</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;PowerPC&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_PPC64</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;PowerPC 64-bit&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_S390</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;IBM S/390&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_ARM</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Advanced RISC Machines&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_SH</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Renesas SuperH&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_SPARCV9</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;SPARC v9 64-bit&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_IA_64</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Intel Itanium&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_X86_64</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;Advanced Micro Devices X86-64&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="JumpStatement Token SPACE">    </span><span class="Keyword LabeledStatement Token CASE">case</span><span class="Keyword LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">EM_VAX</span><span class="LabeledStatement Token COLON">:</span><span class="LabeledStatement Token SPACE"> </span><span class="Identifier Token PrimaryExpression ID">elf_machine_name</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token AssignOp AssignmentExpression ASSIGN">=</span><span class="Token AssignOp AssignmentExpression SPACE"> </span><span class="String Token STRING">&quot;DEC Vax&quot;</span><span class="LabeledStatement Token ExpressionStatement SEMI">;</span><span class="LabeledStatement Token ExpressionStatement SPACE"> </span><span class="Keyword JumpStatement Token BREAK">break</span><span class="JumpStatement Token SEMI">;</span><span class="JumpStatement Token LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span></code></pre><p>段表中的每一个段由如下的结构体储存, 可以计算得到该结构体占据 (4x4+8x6) = 64 个字节</p><pre class="language-c"><code><span class="Keyword Token StorageType TYPEDEF">typedef</span><span class="Keyword Token StorageType SPACE"> </span><span class="Structure Token TypeSpecifier StructureType Keyword STRUCT">struct</span><span class="Structure Token TypeSpecifier StructureType Keyword SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_name</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段名</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_type</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段类型</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_flags</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">     </span><span class="Token StructDeclaration COMMENT">// 段标志位</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">Elf64_Addr</span><span class="Keyword Token TypeSpecifier Typedefine SPACE"> </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_addr</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段虚拟地址</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">Elf64_Off</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">  </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_offset</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">// 段偏移</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_size</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段长度</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_link</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段链接信息</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint32_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_info</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">      </span><span class="Token StructDeclaration COMMENT">// 段链接信息</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_addralign</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">// 段地址对齐</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Keyword Token TypeSpecifier Typedefine TYPEDEF_ID">uint64_t</span><span class="Keyword Token TypeSpecifier Typedefine SPACE">   </span><span class="Identifier DirectDeclaractor Token TypeSpecifier ID">sh_entsize</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">   </span><span class="Token StructDeclaration COMMENT">// 项长度</span><span class="Token StructDeclaration LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Structure Token SPACE"> </span><span class="Identifier DirectDeclaractor Token Typedefine ID">Elf64_Shdr</span><span class="Declaration Token SEMI">;</span></code></pre><p>当然这里也可以使用 <code>readelf -h</code> 列出 ELF Header 查看到一共有段表中有14项,每一项对应每一个段都是64字节, 总大小为 64x14= 896B = 0x380</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506010254.png" alt="20230506010254"></p><p>因此可以画出整个 ELF 文件的排布, 0x000 - 0x40c 之间分别对应各个段, 0x40c - 0x410 对齐, 0x410 之后是段表, 段表一共0x380字节所以粽子节数为 0x410 + 0x380 = 0x790 = 1936 字节, 也就是整个ELF文件的大小</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506010854.png" alt="20230506010854"></p><p>下面这张图中 0x410 之后就是段表, 之前就是所有的段. 读者可能敏锐的注意到 0x410 前面记录了一些段的名字, <b>这是因为段本身并不记录其名字</b>, 结构体中的 sh_name 是一个 uint32_t 类型的数据, 这是一个索引值. 段的名字在 <code>.shstrtab</code> 段中统一记录, 对应是最后一个段所以在这里刚好可以看到</p><p>因为 ELF 文件中用到了很多字符串, 比如段名,变量名等等, 字符串的长度往往是不确定的, 所以用固定的结构来表示它比较困难. 一种常见的做法就是把字符串集中起来存在一个表中, 这一点和ext文件系统的inode对于文件名的管理方式有些类似</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230506004340.png" alt="20230506004340"></p><h3 id="h3-3">段类型和标志位</h3><p>段的名字只是在连接和编译的过程中才有意义, 我们也可以将一个数据段命名为 .text, 因此对于编译器和链接器来说, <b>主要决定段的属性的是段的类型(sh_type)和段的标志位(sh_flags)</b></p><p>段的类型如下所示</p><table><tr><th>选项</th><th>含义</th></tr><tr><td style="text-align:left">                SHT_NULL</td><td style="text-align:left">                该节区不包含任何信息</td></tr><tr><td style="text-align:left">                SHT_PROGBITS</td><td style="text-align:left">                该节区包含程序定义的信息,如代码、数据、常量等</td></tr><tr><td style="text-align:left">                SHT_SYMTAB</td><td style="text-align:left">                该节区包含符号表</td></tr><tr><td style="text-align:left">                SHT_STRTAB</td><td style="text-align:left">                该节区包含字符串表</td></tr><tr><td style="text-align:left">                SHT_RELA</td><td style="text-align:left">                该节区包含重定位表,用于动态链接</td></tr><tr><td style="text-align:left">                SHT_HASH</td><td style="text-align:left">                该节区包含符号哈希表</td></tr><tr><td style="text-align:left">                SHT_DYNAMIC</td><td style="text-align:left">                该节区包含动态链接信息</td></tr><tr><td style="text-align:left">                SHT_NOTE</td><td style="text-align:left">                该节区包含附加信息,如调试信息</td></tr><tr><td style="text-align:left">                SHT_NOBITS</td><td style="text-align:left">                该节区不占用文件空间,但在内存中有空间</td></tr><tr><td style="text-align:left">                SHT_REL</td><td style="text-align:left">                该节区包含重定位表,用于静态链接</td></tr><tr><td style="text-align:left">                SHT_SHLIB</td><td style="text-align:left">                该节区为保留节区,没有特定含义</td></tr><tr><td style="text-align:left">                SHT_DYNSYM</td><td style="text-align:left">                该节区包含动态符号表,用于动态链接</td></tr></table><table><tr><th>标志位</th><th>含义</th></tr><tr><td style="text-align:left">                SHF_WRITE</td><td style="text-align:left">                可写</td></tr><tr><td style="text-align:left">                SHF_ALLOC</td><td style="text-align:left">                占用内存</td></tr><tr><td style="text-align:left">                SHF_EXECINSTR</td><td style="text-align:left">                可执行</td></tr><tr><td style="text-align:left">                SHF_MERGE</td><td style="text-align:left">                可合并</td></tr><tr><td style="text-align:left">                SHF_STRINGS</td><td style="text-align:left">                包含字符串</td></tr><tr><td style="text-align:left">                SHF_INFO_LINK</td><td style="text-align:left">                包含链接信息</td></tr><tr><td style="text-align:left">                SHF_LINK_ORDER</td><td style="text-align:left">                按顺序链接</td></tr><tr><td style="text-align:left">                SHF_OS_NONCONFORMING</td><td style="text-align:left">                不遵循操作系统规范</td></tr><tr><td style="text-align:left">                SHF_GROUP</td><td style="text-align:left">                属于一个组</td></tr><tr><td style="text-align:left">                SHF_TLS</td><td style="text-align:left">                包含TLS模板</td></tr><tr><td style="text-align:left">                SHF_EXCLUDE</td><td style="text-align:left">                不包含在执行文件中</td></tr><tr><td style="text-align:left">                SHF_COMPRESSED</td><td style="text-align:left">                已压缩</td></tr></table><h3 id="h3-4">段的链接信息</h3><p>观察段表中的各个段, 可以发现有两个以 <code>.rela</code> 开头的段, 分别是 <code>.rela.text</code> 和 <code>.rela.eh_frame</code>, 这两个段的类型都是 <code>RELA</code>, 也就是说这是一个 <b>重定位表</b></p><p>相信读者应该了解, <b>链接器在处理目标文件时, 需要对目标文件中的一些部分进行重定位</b>, 比如回顾源代码 SimpleSecition.c, 不难发现其中 printf 函数被声明了但是并没有具体的函数实现; 例如我们还会使用 .h .c 分别进行函数的声明和实现; 例如使用 extern 来访问在其他文件定义的变量或函数. 在最终生成可执行文件的过程中需要链接器完成符号重定位的过程</p><p><code>.rela.text</code> 就是针对 .text 段的重定位表(需要重定位printf), <code>.data</code> 段在本程序中比较简单只有几个常量, 否则也会出现 <code>.rela.data</code></p><pre class="language-c"><code><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType INT">int</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">printf</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator LPAREN">(</span><span class="Keyword QualifyType Token CONST">const</span><span class="Keyword QualifyType Token SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier CHAR">char</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Pointer Token Declarator POINTER">*</span><span class="Identifier DirectDeclaractor Token ID">format</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator RPAREN">)</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token LF">
</span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_init_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="PrimaryExpression Constant Token NUMBER">84</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">global_uninit_var</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token LF">
</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType VOID">void</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">func1</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator LPAREN">(</span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">i</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Function BraceDepth-0 Token LCURLY_BRACE">{</span><span class="CompoundStatement Function Token LF">
</span><span class="CompoundStatement Function Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="String Token STRING">&quot;</span><span class="Format String Token STRING">%d</span><span class="Control String Token STRING">\n</span><span class="String Token STRING">&quot;</span><span class="PPtoken Token COMMA">,</span><span class="Identifier Token ID">i</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="CompoundStatement Function BraceDepth-0 Token RCURLY_BRACE">}</span><span class="CompoundStatement Function Token LF">
</span><span class="CompoundStatement Function Token LF">
</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType INT">int</span><span class="Token BaseType TypeSpecifier Keyword FunctionReturnType SPACE"> </span><span class="Identifier DirectDeclaractor Token FunctionName ID">main</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator LPAREN">(</span><span class="Keyword Token BaseType TypeSpecifier VOID">void</span><span class="BraceDepth-0 DirectDeclaractor Token Declarator RPAREN">)</span><span class="DirectDeclaractor Token Declarator SPACE"> </span><span class="CompoundStatement Function BraceDepth-0 Token LCURLY_BRACE">{</span><span class="CompoundStatement Function Token LF">
</span><span class="CompoundStatement Function Token SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="PrimaryExpression Constant Token NUMBER">85</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Keyword Token StorageType STATIC">static</span><span class="Keyword Token StorageType SPACE"> </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">static_var2</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">a</span><span class="Identifier DirectDeclaractor Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="PrimaryExpression Constant Token NUMBER">1</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Keyword Token BaseType TypeSpecifier INT">int</span><span class="Keyword Token BaseType TypeSpecifier SPACE"> </span><span class="Identifier DirectDeclaractor Token ID">b</span><span class="Declaration Token SEMI">;</span><span class="Declaration Token LF">
</span><span class="Declaration Token SPACE">    </span><span class="Identifier Token PrimaryExpression FunctionName ID">func1</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">static_var</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">static_var2</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">a</span><span class="Identifier Token SPACE"> </span><span class="PPtoken Token PLUS">+</span><span class="PPtoken Token SPACE"> </span><span class="Identifier Token ID">b</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="CompoundStatement Function BraceDepth-0 Token RCURLY_BRACE">}</span></code></pre><p>使用 <code>objdump -x SimpleSection.o</code> 可以看到 SYMBOL TABLE 中的 printf 的属性为 UND</p><pre class="language-shell"><code><span class="Program Token ID">SYMBOL</span><span class="Token SPACE"> </span><span class="Token ID">TABLE:</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">    </span><span class="Token ID">df</span><span class="Token SPACE"> </span><span class="Token MUL">*</span><span class="Token ID">ABS</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">SimpleSection.c</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">    </span><span class="Token ID">d</span><span class="Token SPACE">  </span><span class="Token ID">.rodata</span><span class="Token SPACE">        </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">.rodata</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_var.1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Program Token ID">l</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">static_var2.0</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.data</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_init_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">g</span><span class="Token SPACE">     </span><span class="Token ID">O</span><span class="Token SPACE"> </span><span class="Token ID">.bss</span><span class="Token SPACE">   </span><span class="Token NUMBER">0000000000000004</span><span class="Token SPACE"> </span><span class="Token ID">global_uninit_var</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Program Token ID">g</span><span class="Token SPACE">     </span><span class="Token ID">F</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">000000000000002</span><span class="Token ID">b</span><span class="Token SPACE"> </span><span class="Token ID">func1</span><span class="Token LF">
</span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">         </span><span class="Token MUL">*</span><span class="Program Token ID">UND</span><span class="Token MUL">*</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token ID">printf</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000002</span><span class="Program Token ID">b</span><span class="Token SPACE"> </span><span class="Token ID">g</span><span class="Token SPACE">     </span><span class="Token ID">F</span><span class="Token SPACE"> </span><span class="Token ID">.text</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000039</span><span class="Token SPACE"> </span><span class="Token ID">main</span></code></pre><p>如果段的类型是与链接相关的, 比如重定位表(.rela)和符号表(.symtab), 那么 sh_link 和 sh_info 这两个段就有含义, 否则是无意义的.</p><p>对于重定位表 RELA, sh_link 代表符号表(.symbol)的下标, sh_info 表示它作用于哪个段. 如下所示</p><pre class="language-shell"><code><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Program Token ID">Nr</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Token ID">Name</span><span class="Token SPACE">              </span><span class="Token ID">Type</span><span class="Token SPACE">             </span><span class="Token ID">Address</span><span class="Token SPACE">           </span><span class="Token ID">Offset</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Program Token ID">Size</span><span class="Token SPACE">              </span><span class="Token ID">EntSize</span><span class="Token SPACE">          </span><span class="Token ID">Flags</span><span class="Token SPACE">  </span><span class="Token ID">Link</span><span class="Token SPACE">  </span><span class="Token ID">Info</span><span class="Token SPACE">  </span><span class="Token ID">Align</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">1</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.text</span><span class="Token SPACE">             </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000040</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000064</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Program Token ID">AX</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.rela.text</span><span class="Token SPACE">        </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">000002</span><span class="Token ID">f0</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000078</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Program Token ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">1</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Program Token ID">...</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token SPACE"> </span><span class="Token NUMBER">9</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.eh_frame</span><span class="Token SPACE">         </span><span class="Token ID">PROGBITS</span><span class="Token SPACE">         </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000100</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000058</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">   </span><span class="Program Token ID">A</span><span class="Token SPACE">       </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">0</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token NUMBER">10</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.rela.eh_frame</span><span class="Token SPACE">    </span><span class="Token ID">RELA</span><span class="Token SPACE">             </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000368</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000030</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">   </span><span class="Program Token ID">I</span><span class="Token SPACE">      </span><span class="Token NUMBER">11</span><span class="Token SPACE">     </span><span class="Token NUMBER">9</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="BraceDepth-0 Token LSQUAR_PAREN">[</span><span class="Token NUMBER">11</span><span class="BraceDepth-0 Token RSQUAR_PAREN">]</span><span class="Token SPACE"> </span><span class="Program Token ID">.symtab</span><span class="Token SPACE">           </span><span class="Token ID">SYMTAB</span><span class="Token SPACE">           </span><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE">  </span><span class="Token NUMBER">00000158</span><span class="Token LF">
</span><span class="Token SPACE">       </span><span class="Token NUMBER">0000000000000138</span><span class="Token SPACE">  </span><span class="Token NUMBER">0000000000000018</span><span class="Token SPACE">          </span><span class="Token NUMBER">12</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span><span class="Token SPACE">     </span><span class="Token NUMBER">8</span></code></pre><blockquote><p>这里作者列出了一个表格, 不过稍微有点复杂和难记, 这里笔者将其省略</p></blockquote><h2 id="h2-5">参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/380908650" target="_blank">ELF 文件解析 1-前述+文件头分析</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/readelf" >readelf</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/README",".","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>